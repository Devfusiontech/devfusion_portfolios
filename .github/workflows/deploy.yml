name: Deploy Staging → Portfolio

on:
  push:
    branches:
      - '*_staging'

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: endsWith(github.ref_name, '_staging')
    permissions:
      contents: write

    steps:
      - name: Set branch / folder / container mapping
        id: map
        run: |
          case "${GITHUB_REF_NAME}" in
            abdullah_staging)
              echo "folder=abdullah_site"     >> $GITHUB_OUTPUT
              echo "container=abdullah-site"  >> $GITHUB_OUTPUT
              echo "staging_branch=abdullah_staging" >> $GITHUB_OUTPUT
              echo "portfolio_branch=abdullah_portfolio" >> $GITHUB_OUTPUT
              ;;
            imran_staging)
              echo "folder=imran_site"        >> $GITHUB_OUTPUT
              echo "container=imran-site"     >> $GITHUB_OUTPUT
              echo "staging_branch=imran_staging" >> $GITHUB_OUTPUT
              echo "portfolio_branch=imran_portfolio" >> $GITHUB_OUTPUT
              ;;
            # Add other employees similarly...
            *)
              echo "Unknown branch: ${GITHUB_REF_NAME}"
              exit 1
              ;;
          esac

      - name: Deploy → Merge & Restart on Server
        env:
          SSH_KEY: ${{ secrets.devfusion }}
          SERVER_IP: 144.91.124.246
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/temp_key
          chmod 600 ~/.ssh/temp_key
          ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts 2>/dev/null

          ssh -i ~/.ssh/temp_key -o IdentitiesOnly=yes root@$SERVER_IP << EOF
            set -e

            cd /var/www/html/${{ steps.map.outputs.folder }} || exit 1

            # Fetch latest changes
            git fetch origin

            # Checkout portfolio branch
            git checkout ${{ steps.map.outputs.portfolio_branch }} || git checkout -b ${{ steps.map.outputs.portfolio_branch }} origin/${{ steps.map.outputs.portfolio_branch }}

            # Merge staging branch into portfolio, preferring staging changes
            git merge -X theirs origin/${{ steps.map.outputs.staging_branch }} -m "Merge staging into portfolio"

            # Reset and clean to ensure working folder matches branch
            git reset --hard HEAD
            git clean -fdx

            echo "Restarting container ${{ steps.map.outputs.container }}"
            docker restart ${{ steps.map.outputs.container }} || true

            echo "Restarting ReverseProxy..."
            docker restart ReverseProxy || true

            echo "Deployment complete for ${{ steps.map.outputs.folder }}"
EOF
