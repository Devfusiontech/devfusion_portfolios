# File: .github/workflows/deploy-portfolio.yml
name: Auto Merge + Deploy (Site + ReverseProxy Restart)

on:
  push:
    branches:
      - '*_staging'

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: endsWith(github.ref_name, '_staging')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Map staging → main | folder | container
        id: map
        run: |
          case ${{ github.ref_name }} in
            abdullah_staging)  echo "main=abdullah_portfolio folder=abdullah_site   container=abdullah-site"   >> $GITHUB_OUTPUT ;;
            imran_staging)     echo "main=imran_portfolio    folder=imran_site      container=imran-site"      >> $GITHUB_OUTPUT ;;
            kmisbah_staging)   echo "main=kmisbah_portfolio  folder=kmisbah         container=kmisbah-site"    >> $GITHUB_OUTPUT ;;
            mahnoor_staging)   echo "main=mahnoor_portfolio  folder=mahnoor_site    container=mahnoor-site"    >> $GITHUB_OUTPUT ;;
            maria_staging)     echo "main=maria_portfolio    folder=maria_site      container=maria-site"      >> $GITHUB_OUTPUT ;;
            misbah_staging)    echo "main=misbah_portfolio   folder=misbah_site     container=misbah-site"     >> $GITHUB_OUTPUT ;;
            nouman_staging)    echo "main=nouman_portfolio   folder=nouman_site     container=nouman-site"     >> $GITHUB_OUTPUT ;;
            rehan_staging)     echo "main=rehan_portfolio    folder=rehan_site      container=rehan-site"      >> $GITHUB_OUTPUT ;;
            sidra_staging)     echo "main=sidra_portfolio    folder=sidra_site      container=sidra-site"      >> $GITHUB_OUTPUT ;;
            salma_staging)     echo "main=salma_portfolio    folder=salma_site      container=salma-site"      >> $GITHUB_OUTPUT ;;
            talal_staging)     echo "main=talal_portfolio    folder=talal_site      container=talal-site"      >> $GITHUB_OUTPUT ;;
            zahra_staging)     echo "main=zahra_portfolio    folder=zahra_site      container=zahra-site"      >> $GITHUB_OUTPUT ;;
            *) echo "Unknown staging branch"; exit 1 ;;
          esac

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Merge staging → main branch
        run: |
          git checkout ${{ steps.map.outputs.main }}
          git merge origin/${{ github.ref_name }} --no-ff -m "Auto-merge staging to main [ci skip]"
          git push origin ${{ steps.map.outputs.main }}

      - name: Deploy → Pull code + Restart site + Restart ReverseProxy
        env:
          SSH_KEY: ${{ secrets.devfusion }}
          SERVER_IP: 144.91.124.246
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/temp_key
          chmod 600 ~/.ssh/temp_key
          ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts 2>/dev/null

          ssh -i ~/.ssh/temp_key -o IdentitiesOnly=yes root@$SERVER_IP << 'EOF'
            cd /var/www/html/${{ steps.map.outputs.folder }} || { echo "Folder not found"; exit 1; }

            git fetch --all
            git reset --hard origin/${{ steps.map.outputs.main }}
            git clean -fdx

            echo "Restarting site container: ${{ steps.map.outputs.container }}"
            docker restart ${{ steps.map.outputs.container }} || true

            echo "Restarting ReverseProxy container..."
            docker restart ReverseProxy || true

            echo "Deployed ${{ steps.map.outputs.folder }} successfully!"
          EOF

          rm -f ~/.ssh/temp_key
